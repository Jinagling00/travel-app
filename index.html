<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morandi Travel Planner å°åŒ—å‡ç´šç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ9u7E1D8Q3Gpnh0ySgG+i/O7J+tQ6v/Wd5nNlE/C8f7m42s5r5F4/L0D4qI/O9I0Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* è«è˜­è¿ª/å¥¶èŒ¶é¢¨æ ¼é…è‰² */
        :root {
            --color-primary: #D7C49E; /* æ·ºå’–/å¥¶èŒ¶ */
            --color-secondary: #F7F5E6; /* ç±³ç™½/èƒŒæ™¯ */
            --color-accent: #AEC6CF; /* è«è˜­è¿ªè— */
            --color-dark: #6B5B54; /* æ·±å’–/æ–‡å­— */
            --color-light: #FFFFFF; /* ç´”ç™½ */
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-secondary);
            color: var(--color-dark);
        }
        h1, h2, h3 {
            font-family: 'Lora', serif;
        }
        .card {
            background-color: var(--color-light);
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-light);
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--color-dark);
        }
        .nav-icon.active {
            color: var(--color-accent);
            transform: scale(1.1);
        }

        /* é—œéµå„ªåŒ–ï¼šåº•éƒ¨å°è¦½åˆ—é«˜åº¦èª¿æ•´ */
        main {
            padding-bottom: 6rem; /* å¢åŠ åº•éƒ¨å¡«å……ï¼Œç¢ºä¿å…§å®¹ä¸æœƒè¢«å°èˆªæ¬„é®æ“‹ */
        }
        /* æ™‚é–“è»¸æ¨£å¼ä¿ç•™ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.125rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-primary);
            z-index: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -0.375rem;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            background-color: var(--color-accent);
            border-radius: 50%;
            border: 2px solid var(--color-light);
            z-index: 10;
        }
        .hidden-file-input {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 p-4 shadow-md z-20" style="background-color: var(--color-secondary);">
        <h1 class="text-2xl font-bold text-center" style="color: var(--color-primary);">Morandi Travel Buddy</h1>
    </header>

    <main class="p-4 overflow-y-auto">

        <section id="plan" class="tab-content active">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">âœˆï¸ è¡Œç¨‹ç¸½è¦½ PLAN</h2>
            <div class="space-y-4 mb-6">
                <div class="card p-4">
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-ticket-alt"></i> äº¤é€š/ä½å®¿è³‡è¨Š</h3>
                    <div id="info-display">
                        <p class="text-sm">å°šæœªè¨­å®šåŸºæœ¬è³‡è¨Š</p>
                    </div>
                    <button class="btn-primary w-full mt-2" onclick="openModal('info-modal')">
                        ç·¨è¼¯åŸºæœ¬è³‡è¨Š
                    </button>
                </div>
            </div>
            <div id="daily-schedule" class="space-y-6">
                </div>
        </section>

        <section id="guide" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ—ºï¸ å°åŒ—å°è¦½ GUIDE</h2>

            <div class="card p-5 space-y-6">

                <div class="border-b pb-4" style="border-color: var(--color-primary);">
                    <h3 class="text-2xl font-semibold mb-2" style="color: var(--color-primary);">åœ‹ç«‹æ•…å®®åšç‰©é™¢</h3>
                    <p class="text-sm italic mb-3">åœ°å€ï¼šå°åŒ—å¸‚å£«æ—å€è‡³å–„è·¯äºŒæ®µ221è™Ÿ</p>

                    <h4 class="font-semibold text-lg" style="color: var(--color-dark);">ğŸ« ç¥¨åƒ¹è³‡è¨Š (åƒ…ä¾›åƒè€ƒ)</h4>
                    <ul class="text-sm list-disc list-inside ml-2">
                        <li>**æ™®é€šåƒè§€åˆ¸:** NT$ 350</li>
                        <li>**å„ªæƒ åƒè§€åˆ¸ (å­¸ç”Ÿã€è»è­¦):** NT$ 150</li>
                        <li>**å…è²»åƒè§€:** 65æ­²ä»¥ä¸Šé•·è€…ã€èº«å¿ƒéšœç¤™è€…ã€æœªæ»¿18æ­²è€…ï¼ˆä¾ç¾å ´å…¬å‘Šç‚ºæº–ï¼‰</li>
                    </ul>
                    <a href="https://www.google.com/maps/search/?api=1&query=åœ‹ç«‹æ•…å®®åšç‰©é™¢" target="_blank" class="text-sm block mt-3 underline" style="color: var(--color-accent);"><i class="fas fa-map-marker-alt"></i> Google Maps å°èˆª</a>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold mb-2" style="color: var(--color-primary);">å°åŒ—æ·é‹æ­ä¹˜é ˆçŸ¥</h3>
                    <h4 class="font-semibold text-lg" style="color: var(--color-dark);">ğŸš‡ å¸¸ç”¨æé†’</h4>
                    <ul class="text-sm list-disc list-inside ml-2">
                        <li>**è»Šå»‚å…§ç¦æ­¢:** é£²é£Ÿã€åš¼é£Ÿå£é¦™ç³–æˆ–æª³æ¦”ã€‚</li>
                        <li>**ç¥¨å¡:** å¯ä½¿ç”¨æ‚ éŠå¡ã€ä¸€å¡é€šã€æ„›é‡‘å¡æˆ–è³¼è²·å–®ç¨‹ç¥¨ã€‚</li>
                        <li>**é å³ç«™ç«‹:** æ­ä¹˜é›»æ‰¶æ¢¯æ™‚è«‹é å³ç«™ç«‹ï¼Œå·¦å´ç•™çµ¦è¶•æ™‚é–“çš„æ—…å®¢é€šè¡Œã€‚</li>
                    </ul>
                    <a href="https://www.travel.taipei/zh-tw/information/traffic/taipei-mrt" target="_blank" class="btn-primary inline-block text-sm mt-3" style="background-color: var(--color-accent);">
                        <i class="fas fa-subway"></i> æŸ¥çœ‹å°åŒ—æ·é‹è·¯ç·šåœ–
                    </a>
                </div>
            </div>
        </section>

        <section id="wallet" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ’° åˆ†å¸³èˆ‡åŒ¯ç‡ WALLET</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-calculator"></i> å³æ™‚åŒ¯ç‡æ›ç®— (TWD)</h3>
                <div class="flex space-x-2 mb-2 items-center">
                    <label for="currency-select" class="block text-sm font-medium">åŒ¯ç‡åŸºæº–:</label>
                    <select id="currency-select" onchange="updateExchangeRate()" class="p-2 border rounded-lg text-center flex-grow" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                        <option value="1">TWD (å°å¹£)</option>
                        <option value="32.5" data-symbol="USD">USD (ç¾å…ƒ)</option>
                        <option value="35" data-symbol="EUR">EUR (æ­å…ƒ)</option>
                        <option value="0.21" data-symbol="JPY" selected>JPY (æ—¥å¹£)</option>
                        <option value="0.024" data-symbol="KRW">KRW (éŸ“å…ƒ)</option>
                    </select>
                </div>
                <div class="flex mb-2 space-x-2">
                    <input type="text" id="calc-input" placeholder="è¼¸å…¥é‡‘é¡æˆ–ç®—å¼ (e.g., 500+200*3)" class="flex-grow p-3 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <button class="btn-primary" onclick="calculateExchange()">=</button>
                </div>
                <div class="text-right text-lg font-bold">
                    <span id="calc-result-foreign" class="text-red-600">0</span>
                    <span class="text-sm" id="foreign-symbol"> JPY â‰ˆ </span>
                    <span id="calc-result-twd" style="color: var(--color-dark);">0.00 TWD</span>
                </div>
                <input type="hidden" id="exchange-rate" value="0.21"> </div>

            <div class="card p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-user-friends"></i> æ–°å¢æ¶ˆè²»ç´€éŒ„èˆ‡åˆ†å¸³</h3>

                <div class="mb-3 border-b pb-2" style="border-color: var(--color-secondary);">
                    <p class="text-sm font-semibold mb-1">åˆ†å¸³ä½¿ç”¨è€… (é»æ“Šç·¨è¼¯)</p>
                    <div id="user-names-container" class="flex space-x-2 overflow-x-auto pb-1">
                        </div>
                </div>

                <input type="text" id="expense-item" placeholder="å“é …åç¨± (e.g. æ™šé¤)" class="w-full p-3 mb-2 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                <input type="number" id="expense-amount" placeholder="é‡‘é¡ (ä»¥å¤–å¹£è¨ˆç®—)" class="w-full p-3 mb-2 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">

                <div class="flex items-center mb-2">
                    <label class="font-medium text-sm mr-2">è¨˜å¸³äºº:</label>
                    <select id="expense-payer" class="p-2 border rounded-lg flex-grow" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                        </select>
                </div>

                <input type="file" id="expense-photo-input" accept="image/*" class="hidden-file-input" onchange="handleImageUpload(event)">
                <button class="btn-primary w-full mb-2" onclick="document.getElementById('expense-photo-input').click()">
                    <i class="fas fa-camera"></i> ä¸Šå‚³æ”¶æ“š/ç…§ç‰‡ (å°‡è‡ªå‹•å£“ç¸®)
                </button>
                <div id="photo-preview-container" class="mb-2 text-center hidden">
                    <p class="text-sm italic">å·²é¸å–ç…§ç‰‡ï¼Œå°‡è‡ªå‹•å£“ç¸®</p>
                </div>

                <button class="btn-primary w-full" onclick="addExpense()">
                    å„²å­˜è¨˜å¸³
                </button>
            </div>

            <div class="card p-4">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-list-alt"></i> è¨˜å¸³æ­·å²</h3>
                <div id="expense-history" class="space-y-4">
                    </div>
                <div class="mt-4 pt-4 border-t" style="border-color: var(--color-primary);">
                    <h4 class="text-lg font-bold">ç¸½æ”¯å‡ºï¼š
                        <span id="total-foreign" class="text-red-600">0</span> <span id="total-symbol">JPY</span> â‰ˆ
                        <span id="total-twd" style="color: var(--color-dark);">0.00 TWD</span>
                    </h4>
                </div>
            </div>
        </section>

        <section id="lists" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ“‹ æ¸…å–®å‚™å¿˜ LISTS</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-suitcase-rolling"></i> è¡Œå‰æº–å‚™æ¸…å–®</h3>
                <div class="flex mb-2 space-x-2">
                    <input type="text" id="new-checklist-item" placeholder="æ–°å¢æº–å‚™é …ç›®" class="flex-grow p-2 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <button class="btn-primary" onclick="addChecklistItem()">æ–°å¢</button>
                </div>
                <ul id="checklist-items" class="space-y-2">
                    </ul>
            </div>

            <div class="card p-4">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-clipboard"></i> å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-input" rows="5" placeholder="è‡ªç”±è¼¸å…¥æ–‡å­—ï¼Œç¶²å€æœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•..."
                    class="w-full p-3 border rounded-lg mb-3" style="border-color: var(--color-primary); background-color: var(--color-secondary);"
                    oninput="saveMemo()"></textarea>

                <div id="memo-display" class="p-3 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <p class="text-sm italic">å‚™å¿˜éŒ„å…§å®¹ (é€£çµå°‡æœƒè‡ªå‹•ç”Ÿæˆ)</p>
                    </div>
            </div>
        </section>

        <section id="ai" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ¤– AI æ™ºæ…§å•ç­”</h2>
            <div class="card p-4">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-robot"></i> æ—…éŠå°å¹«æ‰‹ (æ¨¡æ“¬)</h3>
                <div id="chat-box" class="h-80 overflow-y-auto mb-4 p-3 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <div class="text-sm mb-2 text-center italic" style="color: var(--color-accent);">
                        AI æ¨¡æ“¬å•ç­”å·²å°±ç·’ï¼Œè«‹æå•ã€‚
                    </div>
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="ai-input" placeholder="å•æˆ‘å°åŒ—æ™¯é»ã€ç¾é£Ÿæˆ–å¤©æ°£..." class="flex-grow p-3 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-light);" onkeypress="if(event.key === 'Enter') sendAIQuery()">
                    <button class="btn-primary" onclick="sendAIQuery()">
                        ç™¼é€
                    </button>
                </div>
            </div>
        </section>


        <section id="info" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ’¡ å¯¦ç”¨è³‡è¨Š INFO</h2>

            <div class="card p-4 space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-cloud-sun-rain"></i> å°åŒ—å¤©æ°£é å ±</h3>
                    <p class="text-sm mb-2">é»æ“ŠæŸ¥çœ‹å°åŒ—ç•¶åœ°æœ€æ–°å¤©æ°£è³‡è¨Šï¼š</p>
                    <a href="https://www.cwb.gov.tw/V8/C/W/index.html" target="_blank" class="btn-primary inline-block text-center text-sm" style="background-color: var(--color-accent);">
                        <i class="fas fa-umbrella"></i> å°ç£å°åŒ—ä¸­å¤®æ°£è±¡ç½²
                    </a>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-phone-alt"></i> ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>
                    <ul class="text-sm space-y-1">
                        <li>**è­¦å¯Ÿ:** 110 (å°ç£)</li>
                        <li>**æ•‘è­·è»Š/æ¶ˆé˜²:** 119 (å°ç£)</li>
                        <li>**å¤–äº¤éƒ¨æ—…å¤–åœ‹äººç·Šæ€¥æœå‹™å°ˆç·š:** <a href="tel:+886800085095" class="underline" style="color: var(--color-accent);">(+886) 800-085-095</a></li>
                        <li>**æ—…éŠæœå‹™ç†±ç·š (è§€å…‰å±€):** 0800-011765</li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-20 shadow-lg flex justify-around items-center z-30" style="background-color: var(--color-light); border-top: 1px solid var(--color-primary);">
        <button class="nav-btn flex flex-col items-center p-2" data-tab="plan" onclick="switchTab('plan')">
            <i class="fas fa-plane nav-icon text-xl active"></i>
            <span class="text-xs mt-1">PLAN</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="guide" onclick="switchTab('guide')">
            <i class="fas fa-map-marked-alt nav-icon text-xl"></i>
            <span class="text-xs mt-1">GUIDE</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="wallet" onclick="switchTab('wallet')">
            <i class="fas fa-wallet nav-icon text-xl"></i>
            <span class="text-xs mt-1">WALLET</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="lists" onclick="switchTab('lists')">
            <i class="fas fa-list-check nav-icon text-xl"></i>
            <span class="text-xs mt-1">LISTS</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="ai" onclick="switchTab('ai')">
            <i class="fas fa-brain nav-icon text-xl"></i>
            <span class="text-xs mt-1">AI</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="info" onclick="switchTab('info')">
            <i class="fas fa-info-circle nav-icon text-xl"></i>
            <span class="text-xs mt-1">INFO</span>
        </button>
    </nav>

    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <div class="card w-full max-w-md p-6 overflow-y-auto max-h-[90vh]" style="background-color: var(--color-secondary);">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">ç·¨è¼¯æ—…éŠåŸºæœ¬è³‡è¨Š</h3>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">è»Šç¥¨/èˆªç­è³‡è¨Š</label>
                <textarea id="input-transport" rows="3" class="w-full p-2 border rounded-lg" placeholder="è«‹å¡«å…¥æ­ä¹˜æ—¥æœŸã€è»Šæ¬¡ã€èˆªç­è™Ÿç¢¼..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">ä½å®¿è³‡è¨Š</label>
                <textarea id="input-lodging" rows="3" class="w-full p-2 border rounded-lg" placeholder="è«‹å¡«å…¥ä½å®¿æ—¥æœŸã€é£¯åº—åç¨±èˆ‡åœ°å€..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">D1 è¡Œç¨‹</label>
                <textarea id="input-day1" rows="3" class="w-full p-2 border rounded-lg" placeholder="ç¬¬ä¸€å¤©è¡Œç¨‹å…§å®¹..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">D2 è¡Œç¨‹</label>
                <textarea id="input-day2" rows="3" class="w-full p-2 border rounded-lg" placeholder="ç¬¬äºŒå¤©è¡Œç¨‹å…§å®¹..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">D3 è¡Œç¨‹</label>
                <textarea id="input-day3" rows="3" class="w-full p-2 border rounded-lg" placeholder="ç¬¬ä¸‰å¤©è¡Œç¨‹å…§å®¹..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button class="btn-primary" onclick="saveTripInfo()">å„²å­˜ä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <div class="card w-full max-w-sm p-6" style="background-color: var(--color-secondary);">
            <h3 class="text-xl font-bold mb-4" style="color: var(--color-primary);">ç·¨è¼¯åˆ†å¸³ä½¿ç”¨è€…åç¨±</h3>
            <div id="user-inputs-container" class="space-y-3">
                </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button class="btn-primary" onclick="saveUserNames()">å„²å­˜ä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>


    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const DB_PREFIX = 'TRAVEL_APP_TW_';
        let expensePhotoBase64 = null; // æš«å­˜ä¸Šå‚³çš„ Base64 åœ–ç‰‡

        // é è¨­ä½¿ç”¨è€…åç¨±
        const DEFAULT_USERS = ["ä½¿ç”¨è€… A", "ä½¿ç”¨è€… B", "ä½¿ç”¨è€… C", "ä½¿ç”¨è€… D"];
        let currentUsers = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadUserNames(); // å„ªå…ˆè¼‰å…¥ä½¿ç”¨è€…åç¨±
            loadTripInfo();
            loadChecklist();
            loadMemo();
            loadExpenses();
            updateExchangeRate();
            switchTab('plan'); // é è¨­åˆ‡æ›åˆ° PLAN é é¢
        });

        // --- å°èˆªèˆ‡åˆ†é åˆ‡æ›åŠŸèƒ½ ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-tab="${tabId}"] .nav-icon`).classList.add('active');

            if (tabId === 'plan') {
                renderDailySchedule();
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            if (modalId === 'info-modal') {
                const data = JSON.parse(localStorage.getItem(DB_PREFIX + 'trip_info')) || {};
                document.getElementById('input-transport').value = data.transport || '';
                document.getElementById('input-lodging').value = data.lodging || '';
                document.getElementById('input-day1').value = data.day1 || '';
                document.getElementById('input-day2').value = data.day2 || '';
                document.getElementById('input-day3').value = data.day3 || '';
            } else if (modalId === 'user-modal') {
                renderUserInputs();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- 1. PLAN (è¡Œç¨‹è¡¨) æ¨¡çµ„ ---
        function saveTripInfo() {
            const info = {
                transport: document.getElementById('input-transport').value.trim(),
                lodging: document.getElementById('input-lodging').value.trim(),
                day1: document.getElementById('input-day1').value.trim(),
                day2: document.getElementById('input-day2').value.trim(),
                day3: document.getElementById('input-day3').value.trim(),
            };
            localStorage.setItem(DB_PREFIX + 'trip_info', JSON.stringify(info));
            loadTripInfo();
            renderDailySchedule();
            closeModal('info-modal');
        }

        function loadTripInfo() {
            const data = JSON.parse(localStorage.getItem(DB_PREFIX + 'trip_info')) || {};
            const infoDisplay = document.getElementById('info-display');

            const transportText = data.transport ? `<p class="text-sm">**äº¤é€š:** ${data.transport.replace(/\n/g, '<br>')}</p>` : '';
            const lodgingText = data.lodging ? `<p class="text-sm">**ä½å®¿:** ${data.lodging.replace(/\n/g, '<br>')}</p>` : '';

            if (transportText || lodgingText) {
                infoDisplay.innerHTML = transportText + lodgingText;
            } else {
                infoDisplay.innerHTML = '<p class="text-sm italic">å°šæœªè¨­å®šåŸºæœ¬è³‡è¨Šï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ã€‚</p>';
            }
        }

        function renderDailySchedule() {
            const data = JSON.parse(localStorage.getItem(DB_PREFIX + 'trip_info')) || {};
            const scheduleContainer = document.getElementById('daily-schedule');
            scheduleContainer.innerHTML = '';

            const days = [
                { id: 'day1', title: 'Day 1 è¡Œç¨‹', content: data.day1 || 'å°šæœªè¨­å®š D1 è¡Œç¨‹' },
                { id: 'day2', title: 'Day 2 è¡Œç¨‹', content: data.day2 || 'å°šæœªè¨­å®š D2 è¡Œç¨‹' },
                { id: 'day3', title: 'Day 3 è¡Œç¨‹', content: data.day3 || 'å°šæœªè¨­å®š D3 è¡Œç¨‹' },
            ];

            days.forEach(day => {
                const items = day.content.split('\n').filter(line => line.trim() !== '');
                const scheduleCard = document.createElement('div');
                scheduleCard.className = 'card p-5';
                scheduleCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-4" style="color: var(--color-accent);">${day.title}</h3>
                    <div class="relative space-y-6">
                        ${items.map(item => {
                            const query = encodeURIComponent(item.split(' ')[0]);
                            return `
                                <div class="timeline-item relative pl-8">
                                    <div class="timeline-dot"></div>
                                    <p class="font-medium">${item}</p>
                                    <div class="flex space-x-2 mt-1 text-xs">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank"
                                            class="flex items-center text-white px-2 py-1 rounded-full" style="background-color: var(--color-accent);">
                                            <i class="fas fa-map-marker-alt mr-1"></i> Google åœ°åœ–
                                        </a>
                                        <a href="https://www.google.com/search?q=${query}+é£Ÿè¨˜+å°åŒ—" target="_blank"
                                            class="flex items-center text-white px-2 py-1 rounded-full" style="background-color: var(--color-primary);">
                                            <i class="fas fa-utensils mr-1"></i> æŸ¥çœ‹é£Ÿè¨˜
                                        </a>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                scheduleContainer.appendChild(scheduleCard);
            });

            if (days.every(d => !d.content)) {
                scheduleContainer.innerHTML = '<p class="text-center p-4 italic" style="color: var(--color-dark);">å°šç„¡è¡Œç¨‹è³‡æ–™ï¼Œè«‹é»æ“Šã€Œç·¨è¼¯åŸºæœ¬è³‡è¨Šã€æ–°å¢ã€‚</p>';
            }
        }

        // --- 3. WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) æ¨¡çµ„ ---

        // ä½¿ç”¨è€…åˆ†å¸³ç³»çµ±
        function loadUserNames() {
            const storedUsers = JSON.parse(localStorage.getItem(DB_PREFIX + 'users'));
            currentUsers = storedUsers || DEFAULT_USERS;
            renderUserButtons();
            renderPayerDropdown();
        }

        function renderUserButtons() {
            const container = document.getElementById('user-names-container');
            container.innerHTML = '';
            currentUsers.forEach((user, index) => {
                const button = document.createElement('button');
                button.className = 'flex-shrink-0 bg-gray-200 text-sm py-1 px-3 rounded-full hover:bg-gray-300';
                button.textContent = user;
                button.onclick = () => openModal('user-modal');
                container.appendChild(button);
            });
             if (currentUsers.length === 0) {
                const button = document.createElement('button');
                button.className = 'flex-shrink-0 btn-primary text-sm py-1 px-3';
                button.textContent = 'è¨­å®šä½¿ç”¨è€…åç¨±';
                button.onclick = () => openModal('user-modal');
                container.appendChild(button);
            }
        }

        function renderPayerDropdown() {
            const dropdown = document.getElementById('expense-payer');
            dropdown.innerHTML = '';
            currentUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                dropdown.appendChild(option);
            });
        }

        function renderUserInputs() {
            const container = document.getElementById('user-inputs-container');
            container.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const inputDiv = document.createElement('div');
                inputDiv.className = 'flex items-center';
                inputDiv.innerHTML = `
                    <span class="w-8 font-semibold">U${i+1}:</span>
                    <input type="text" id="user-input-${i}" value="${currentUsers[i] || DEFAULT_USERS[i]}"
                           class="flex-grow p-2 border rounded-lg" placeholder="ä½¿ç”¨è€…åç¨±"
                           style="border-color: var(--color-primary); background-color: var(--color-light);">
                `;
                container.appendChild(inputDiv);
            }
        }

        function saveUserNames() {
            const newUsers = [];
            for (let i = 0; i < 4; i++) {
                const input = document.getElementById(`user-input-${i}`);
                newUsers.push(input.value.trim() || DEFAULT_USERS[i]);
            }
            currentUsers = newUsers;
            localStorage.setItem(DB_PREFIX + 'users', JSON.stringify(currentUsers));
            renderUserButtons();
            renderPayerDropdown();
            closeModal('user-modal');
        }

        // åŒ¯ç‡è¨ˆç®—æ©Ÿ
        function updateExchangeRate() {
            const select = document.getElementById('currency-select');
            const rate = select.value;
            const symbol = select.options[select.selectedIndex].getAttribute('data-symbol') || select.options[select.selectedIndex].text.split(' ')[0];

            document.getElementById('exchange-rate').value = rate;
            document.getElementById('foreign-symbol').textContent = ` ${symbol} â‰ˆ `;
            document.getElementById('total-symbol').textContent = symbol;
            
            // é‡æ–°è¼‰å…¥ä¸¦æ›´æ–°åˆ—è¡¨ä¸­çš„å°å¹£ç¸½é¡ï¼ˆå› ç‚ºåŒ¯ç‡å¯èƒ½æ”¹è®Šï¼‰
            loadExpenses();
        }

        function calculateExchange() {
            const inputEl = document.getElementById('calc-input');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0;
            const foreignSymbol = document.getElementById('currency-select').options[document.getElementById('currency-select').selectedIndex].getAttribute('data-symbol') || '';
            const foreignResultEl = document.getElementById('calc-result-foreign');
            const twdResultEl = document.getElementById('calc-result-twd');

            let foreignAmount = 0;
            try {
                foreignAmount = eval(inputEl.value.trim().replace(/[^-()\d/*+. ]/g, ''));
                if (isNaN(foreignAmount)) foreignAmount = 0;
                inputEl.value = foreignAmount;
            } catch (e) {
                foreignAmount = 0;
                inputEl.value = 'éŒ¯èª¤: ç„¡æ•ˆç®—å¼';
            }

            const twdAmount = foreignAmount / (rate === 1 ? 1 : rate); // TWD çš„ rate è¨­ç‚º 1

            foreignResultEl.textContent = foreignAmount.toFixed(2);
            twdResultEl.textContent = twdAmount.toFixed(2);
        }

        // åœ–ç‰‡å£“ç¸®ä¸¦è½‰ Base64
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const MAX_WIDTH = 200;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    expensePhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0;
            const currency = document.getElementById('currency-select').options[document.getElementById('currency-select').selectedIndex].getAttribute('data-symbol') || 'TWD';

            if (!item || isNaN(amount) || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …å’Œé‡‘é¡ã€‚');
                return;
            }

            const expenses = JSON.parse(localStorage.getItem(DB_PREFIX + 'expenses')) || [];
            const twdAmount = amount * (rate === 1 ? 1 : (1 / rate)); // è¨ˆç®—æŠ˜åˆå°å¹£ (TWD)
            
            const newExpense = {
                id: Date.now(),
                item: item,
                amount: amount,
                twd: twdAmount,
                payer: payer,
                currency: currency,
                photo: expensePhotoBase64,
                timestamp: new Date().toLocaleDateString('zh-TW')
            };

            expenses.unshift(newExpense);
            localStorage.setItem(DB_PREFIX + 'expenses', JSON.stringify(expenses));

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-photo-input').value = '';
            expensePhotoBase64 = null;
            document.getElementById('photo-preview-container').classList.add('hidden');

            loadExpenses();
        }

        function deleteExpense(id) {
            let expenses = JSON.parse(localStorage.getItem(DB_PREFIX + 'expenses')) || [];
            expenses = expenses.filter(exp => exp.id !== id);
            localStorage.setItem(DB_PREFIX + 'expenses', JSON.stringify(expenses));
            loadExpenses();
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem(DB_PREFIX + 'expenses')) || [];
            const container = document.getElementById('expense-history');
            const totalForeignEl = document.getElementById('total-foreign');
            const totalTwdEl = document.getElementById('total-twd');
            const currentRate = parseFloat(document.getElementById('exchange-rate').value) || 0;
            const currentCurrency = document.getElementById('currency-select').options[document.getElementById('currency-select').selectedIndex].getAttribute('data-symbol') || 'TWD';

            container.innerHTML = '';
            
            let totalForeign = 0;
            let totalTwd = 0;

            expenses.forEach(exp => {
                // é€™è£¡æˆ‘å€‘åªè¨ˆç®—ç¸½å°å¹£ (TWD) ç¸½é¡ï¼Œå› ç‚ºå¤–å¹£ç¸½é¡æœƒå› å¹£åˆ¥æ··é›œè€Œå¤±çœŸ
                totalTwd += exp.twd;

                const photoHtml = exp.photo
                    ? `<img src="${exp.photo}" alt="æ”¶æ“š" class="w-12 h-12 object-cover rounded-md mr-3 shadow-md">`
                    : `<div class="w-12 h-12 flex items-center justify-center rounded-md mr-3" style="background-color: var(--color-secondary);"><i class="fas fa-image text-lg" style="color: var(--color-primary);"></i></div>`;
                
                // é‡æ–°è¨ˆç®—ä»¥å¤–å¹£é¡¯ç¤ºçš„é‡‘é¡ (ä¾æ“šç•¶å‰é¸å–®çš„å¹£åˆ¥)
                const foreignDisplayAmount = exp.twd * (currentRate === 1 ? 1 : currentRate);

                const expenseItem = document.createElement('div');
                expenseItem.className = 'flex items-center p-3 rounded-lg border-b'
                expenseItem.style.borderColor = 'var(--color-secondary)';
                expenseItem.innerHTML = `
                    ${photoHtml}
                    <div class="flex-grow">
                        <p class="font-medium text-sm">${exp.item} <span class="text-xs text-gray-500">(${exp.payer})</span></p>
                        <p class="text-xs text-gray-500">${exp.timestamp}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="font-bold text-sm text-red-600">${foreignDisplayAmount.toFixed(2)} ${currentCurrency}</p>
                        <p class="text-xs" style="color: var(--color-dark);">â‰ˆ ${exp.twd.toFixed(2)} TWD</p>
                    </div>
                    <button class="ml-3 text-red-500 hover:text-red-700" onclick="deleteExpense(${exp.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                container.appendChild(expenseItem);
            });

            // ç¸½é¡éƒ¨åˆ†ï¼šå¤–å¹£ç¸½é¡åªé¡¯ç¤ºç•¶å‰é¸å–®çš„å¹£åˆ¥ï¼Œå¯¦éš›ç¸½é¡ä»¥å°å¹£ç‚ºä¸»
            const totalForeignDisplay = totalTwd * (currentRate === 1 ? 1 : currentRate);

            totalForeignEl.textContent = totalForeignDisplay.toFixed(2);
            totalTwdEl.textContent = totalTwd.toFixed(2);

            if (expenses.length === 0) {
                 container.innerHTML = '<p class="text-center italic text-sm">å°šç„¡æ¶ˆè²»ç´€éŒ„ã€‚</p>';
            }
        }


        // --- 4. LISTS (æ¸…å–®) æ¨¡çµ„ ---
        // è¡Œå‰æº–å‚™ CheckList
        function addChecklistItem() {
            const input = document.getElementById('new-checklist-item');
            const itemText = input.value.trim();
            if (!itemText) return;

            let checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            checklist.push({ id: Date.now(), text: itemText, completed: false });
            localStorage.setItem(DB_PREFIX + 'checklist', JSON.stringify(checklist));
            input.value = '';
            loadChecklist();
        }

        function toggleChecklistItem(id) {
            let checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            const index = checklist.findIndex(item => item.id === id);
            if (index > -1) {
                checklist[index].completed = !checklist[index].completed;
                localStorage.setItem(DB_PREFIX + 'checklist', JSON.stringify(checklist));
                loadChecklist();
            }
        }

        // æ–°å¢ï¼šåˆªé™¤åŠŸèƒ½
        function deleteChecklistItemUI(id) {
            deleteChecklistItem(id);
        }

        function loadChecklist() {
            const checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            const container = document.getElementById('checklist-items');
            container.innerHTML = '';

            checklist.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-lg';
                li.style.backgroundColor = item.completed ? '#E0F2F1' : 'var(--color-light)';

                const textClass = item.completed ? 'line-through text-gray-500' : 'font-medium';
                li.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" ${item.completed ? 'checked' : ''}
                               onclick="toggleChecklistItem(${item.id})"
                               class="w-4 h-4 mr-3" style="accent-color: var(--color-accent);">
                        <span class="${textClass}">${item.text}</span>
                    </div>
                    <button class="text-red-400 hover:text-red-600 ml-3" onclick="deleteChecklistItemUI(${item.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                container.appendChild(li);
            });
            if (checklist.length === 0) {
                 container.innerHTML = '<p class="text-center italic text-sm">å°šç„¡æº–å‚™é …ç›®ã€‚</p>';
            }
        }

        // å€‹äººå‚™å¿˜éŒ„ (ä¿ç•™åŸåŠŸèƒ½)
        function saveMemo() {
            const memoText = document.getElementById('memo-input').value;
            localStorage.setItem(DB_PREFIX + 'memo', memoText);
            renderMemo(memoText);
        }

        function loadMemo() {
            const memoText = localStorage.getItem(DB_PREFIX + 'memo') || '';
            document.getElementById('memo-input').value = memoText;
            renderMemo(memoText);
        }

        function renderMemo(text) {
            const display = document.getElementById('memo-display');
            const urlRegex = /(https?:\/\/[^\s]+)/g;

            const htmlContent = text.replace(/\n/g, '<br>').replace(urlRegex, (url) => {
                const buttonText = url.length > 30 ? url.substring(0, 27) + '...' : url;
                return `
                    <a href="${url}" target="_blank" class="inline-block my-1 mx-0.5 btn-primary text-sm p-1" style="background-color: var(--color-accent);">
                        <i class="fas fa-link"></i> ${buttonText}
                    </a>
                `;
            });
            display.innerHTML = htmlContent || '<p class="text-sm italic">å‚™å¿˜éŒ„å…§å®¹ (é€£çµå°‡æœƒè‡ªå‹•ç”Ÿæˆ)</p>';
        }

        // --- 5. AI (å•ç­”) æ¨¡çµ„ ---
        function sendAIQuery() {
            const input = document.getElementById('ai-input');
            const query = input.value.trim();
            const chatBox = document.getElementById('chat-box');

            if (!query) return;

            // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            appendMessage(query, 'user');
            input.value = '';

            // 2. æ¨¡æ“¬ AI å›æ‡‰ (ç´”å‰ç«¯æ¨¡æ“¬)
            const response = getAIResponse(query);
            setTimeout(() => {
                appendMessage(response, 'ai');
            }, 1000); // æ¨¡æ“¬å»¶é² 1 ç§’å›è¦†
        }

        function appendMessage(text, sender) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');

            const isUser = sender === 'user';
            messageDiv.className = `flex mb-2 ${isUser ? 'justify-end' : 'justify-start'}`;

            messageDiv.innerHTML = `
                <div class="max-w-[80%] p-3 rounded-xl shadow-md text-sm ${isUser ? 'bg-blue-200' : 'bg-gray-100'}"
                     style="background-color: ${isUser ? 'var(--color-accent)' : 'var(--color-light)'}; color: ${isUser ? 'var(--color-light)' : 'var(--color-dark)'};">
                    ${text}
                </div>
            `;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // æ²å‹•åˆ°åº•éƒ¨
        }

        function getAIResponse(query) {
            const lowerQuery = query.toLowerCase();
            if (lowerQuery.includes('æ•…å®®') || lowerQuery.includes('é–€ç¥¨')) {
                return "å°åŒ—æ•…å®®çš„æ™®é€šåƒè§€åˆ¸ç´„ NT$ 350ã€‚æœªæ»¿ 18 æ­²è€…é€šå¸¸å¯å…è²»åƒè§€ï¼Œè©³æƒ…è«‹åƒè€ƒ GUIDE é é¢ã€‚";
            }else if (lowerQuery.includes('ä½ å¥½') || lowerQuery.includes('å—¨')) {
                return "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ—…éŠå°å¹«æ‰‹ï¼Œè«‹å•æœ‰ä»€éº¼æˆ‘å¯ä»¥å”åŠ©æ‚¨çš„å—ï¼Ÿ";
            } else if (lowerQuery.includes('å¤©æ°£')) {
                return "å»ºè­°æ‚¨æŸ¥çœ‹ INFO é é¢çš„ä¸­å¤®æ°£è±¡ç½²é€£çµï¼Œç²å–æœ€æ–°çš„å¤©æ°£è³‡è¨Šï¼";
            }
            return "å¾ˆæŠ±æ­‰ï¼Œé€™æ˜¯ä¸€å€‹æ¨¡æ“¬ AIï¼Œæˆ‘é‚„ç„¡æ³•è™•ç†é€™å€‹è¤‡é›œçš„å•é¡Œã€‚æ‚¨å¯ä»¥è©¦è‘—å•æˆ‘é—œæ–¼æ•…å®®ã€æ·é‹æˆ–ç¾é£Ÿå–”ï¼";
        }

        // --- å•Ÿå‹•æ™‚è¼‰å…¥è³‡æ–™ ---
        // æ”¾åœ¨ DOMContentLoaded ä¹‹å¾ŒåŸ·è¡Œ
    </script>

</body>
</html>
