<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OKINAWA 2026</title>

    <link rel="manifest" href="./manifest.json">

    <link rel="icon" type="image/png" href="https://img.icons8.com/officel/512/shisa.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/officel/512/shisa.png">    
    <meta name="apple-mobile-web-app-title" content="Okinawa2026">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F7F3EE; color: #334155; }
        .ocean-gradient { background: linear-gradient(135deg, #075985 0%, #38BDF8 100%); }
        /* ç¢ºä¿å…§å®¹ä¸æœƒè¢«æ‰‹æ©Ÿç€æµ·é®åˆ° */
        @media screen and (display-mode: standalone) {
            header { padding-top: env(safe-area-inset-top); }
        }
    </style>
</head>
<body class="pb-28">

    <header class="ocean-gradient text-white p-6 rounded-b-[40px] shadow-lg mb-6">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold">Okinawa 2026</h1>
                <p class="text-xs opacity-80">1/24 (å…­) - 1/27 (äºŒ)</p>
            </div>
            <i class="fas fa-umbrella-beach text-3xl opacity-50"></i>
        </div>
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/20">
            <div class="flex justify-between items-center text-xs font-bold">
                <div class="text-center">
                    <p class="opacity-70">å»ç¨‹ JX302</p>
                    <p class="text-lg">13:15</p>
                </div>
                <div class="flex-1 px-4 flex flex-col items-center">
                    <div class="w-full border-t border-dashed border-white/50 relative">
                        <i class="fas fa-plane absolute -top-2 left-1/2 -translate-x-1/2 text-[10px]"></i>
                    </div>
                </div>
                <div class="text-center">
                    <p class="opacity-70">å›ç¨‹ JX313</p>
                    <p class="text-lg">20:30</p>
                </div>
            </div>
        </div>
    </header>

    <main id="app" class="px-4">
        
        <section id="page-plan" class="page-section">
            <div class="flex gap-2 mb-6">
                <button onclick="switchDay(1)" id="d1-btn" class="day-btn flex-1 py-3 rounded-2xl bg-white border border-slate-200 text-sm font-bold day-btn-active">D1</button>
                <button onclick="switchDay(2)" id="d2-btn" class="day-btn flex-1 py-3 rounded-2xl bg-white border border-slate-200 text-sm font-bold">D2</button>
                <button onclick="switchDay(3)" id="d3-btn" class="day-btn flex-1 py-3 rounded-2xl bg-white border border-slate-200 text-sm font-bold">D3</button>
                <button onclick="switchDay(4)" id="d4-btn" class="day-btn flex-1 py-3 rounded-2xl bg-white border border-slate-200 text-sm font-bold">D4</button>
            </div>
            <div id="itinerary-content" class="space-y-4"></div>
            <button onclick="editPlan()" class="w-full mt-6 py-3 border-2 border-dashed border-sky-200 text-sky-600 rounded-2xl text-xs font-bold bg-sky-50/50">
                <i class="fas fa-pencil-alt mr-1"></i> ä¿®æ”¹æœ¬æ—¥è¡Œç¨‹å…§å®¹
            </button>
        </section>

        <section id="page-wallet" class="page-section hidden">
            <div class="bg-white rounded-3xl p-6 card-shadow mb-6 border-t-4 border-sky-500">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Remaining Budget</p>
                        <h2 id="remaining-twd" class="text-3xl font-bold text-slate-700">NT$ 0</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Total Goal</p>
                        <p class="text-sm font-bold text-slate-500">NT$ 50,000</p>
                    </div>
                </div>
                <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                    <div id="budget-bar" class="bg-sky-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="budget-percent" class="text-[9px] text-slate-400 mt-2 font-bold text-right">å·²æ”¯å‡º 0%</p>
            </div>

            <div class="bg-white rounded-3xl p-5 card-shadow mb-6">
                <div class="flex justify-between mb-2 px-1">
                    <span class="text-[10px] font-bold text-slate-400">JPY TO TWD (0.21)</span>
                    <button onclick="calcTax()" class="text-[10px] text-orange-500 font-bold">é€€ç¨…è©¦ç®— (10%)</button>
                </div>
                <div id="calc-display" class="bg-slate-50 p-4 rounded-2xl text-right mb-4">
                    <div id="calc-exp" class="text-xs text-slate-400 h-4"></div>
                    <div id="calc-main" class="text-3xl font-bold text-slate-700">0</div>
                    <div id="calc-twd" class="text-sm text-sky-600 font-bold mt-1">â‰ˆ NT$ 0</div>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('7')">7</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('8')">8</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('9')">9</button>
                    <button class="calc-btn p-4 rounded-xl text-orange-500" onclick="pressCalc('/')">Ã·</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('4')">4</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('5')">5</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('6')">6</button>
                    <button class="calc-btn p-4 rounded-xl text-orange-500" onclick="pressCalc('*')">Ã—</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('1')">1</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('2')">2</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('3')">3</button>
                    <button class="calc-btn p-4 rounded-xl text-orange-500" onclick="pressCalc('-')">-</button>
                    <button class="calc-btn p-4 rounded-xl font-bold" onclick="pressCalc('0')">0</button>
                    <button class="calc-btn p-4 rounded-xl text-rose-500" onclick="clearCalc()">C</button>
                    <button class="calc-btn p-4 rounded-xl bg-sky-500 text-white" onclick="solveCalc()">=</button>
                    <button class="calc-btn p-4 rounded-xl text-orange-500" onclick="pressCalc('+')">+</button>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-5 card-shadow space-y-3 mb-6">
                <h3 class="text-sm font-bold border-b pb-2"><i class="fas fa-receipt mr-2 text-sky-500"></i>åˆ†å¸³è¨˜å¸³</h3>
                <input type="text" id="bill-name" placeholder="å“é …åç¨±" class="w-full">
                <div class="flex gap-2">
                    <input type="number" id="bill-amount" placeholder="é‡‘é¡ (JPY)" class="flex-1">
                    <select id="bill-payer" class="bg-slate-50 w-24">
                        <option value="00">00</option>
                        <option value="å°å®‡">å°å®‡</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <select id="bill-method" class="flex-1 bg-slate-50">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                    </select>
                    <label class="flex-1 bg-sky-50 text-sky-600 text-xs py-3 rounded-xl text-center font-bold cursor-pointer border border-sky-100">
                        <i class="fas fa-camera"></i> æ‹æ”¶æ“š
                        <input type="file" id="bill-img" class="hidden" accept="image/*" onchange="compressImg(this)">
                    </label>
                </div>
                <div id="img-preview" class="hidden h-16 w-16 rounded-lg overflow-hidden border"></div>
                <button onclick="saveBill()" class="w-full py-3 bg-sky-600 text-white rounded-2xl font-bold shadow-md">å„²å­˜å¸³ç›®</button>
            </div>
            
            <div id="split-summary" class="bg-amber-50 p-4 rounded-2xl text-[11px] text-amber-700 font-bold text-center mb-4"></div>
            <div id="bill-list" class="space-y-3 pb-6"></div>
        </section>

        <section id="page-lists" class="page-section hidden">
            <div class="space-y-8">
                <div id="cat-pre">
                    <h3 class="text-xs font-bold text-sky-600 mb-3 tracking-widest uppercase border-l-4 border-sky-500 pl-2">è¡Œå‰æº–å‚™</h3>
                    <div class="list-container bg-white rounded-2xl p-4 card-shadow space-y-3"></div>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="input-pre" placeholder="æ–°å¢äº‹é …..." class="flex-1 text-sm">
                        <button onclick="addListItem('pre')" class="bg-sky-500 text-white w-10 h-10 rounded-xl"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div id="cat-buy">
                    <h3 class="text-xs font-bold text-amber-600 mb-3 tracking-widest uppercase border-l-4 border-amber-500 pl-2">å¿…è²·æ¸…å–®</h3>
                    <div class="list-container bg-white rounded-2xl p-4 card-shadow space-y-3"></div>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="input-buy" placeholder="æ–°å¢ç‰©å“..." class="flex-1 text-sm">
                        <button onclick="addListItem('buy')" class="bg-amber-500 text-white w-10 h-10 rounded-xl"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div id="cat-eat">
                    <h3 class="text-xs font-bold text-rose-500 mb-3 tracking-widest uppercase border-l-4 border-rose-500 pl-2">å¿…åƒç¾é£Ÿ</h3>
                    <div class="list-container bg-white rounded-2xl p-4 card-shadow space-y-3"></div>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="input-eat" placeholder="æ–°å¢ç¾é£Ÿ..." class="flex-1 text-sm">
                        <button onclick="addListItem('eat')" class="bg-rose-500 text-white w-10 h-10 rounded-xl"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-info" class="page-section hidden">
            <div class="bg-white rounded-3xl p-5 card-shadow mb-8">
                <h3 class="text-sm font-bold text-slate-700 mb-4"><i class="fas fa-language mr-2"></i>å³æ™‚ç¿»è­¯èˆ‡èªéŸ³</h3>
                <textarea id="trans-input" placeholder="è¼¸å…¥ä¸­æ–‡..." class="w-full h-20 bg-slate-50 border-0 mb-3 text-sm"></textarea>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="goTranslate('ja')" class="bg-sky-600 text-white py-3 rounded-xl text-xs font-bold">ä¸­ â†’ æ—¥ ç¿»è­¯</button>
                    <button onclick="ttsJapanese()" class="bg-white text-sky-600 border border-sky-100 py-3 rounded-xl text-xs font-bold">æ—¥æ–‡èªéŸ³æœ—è®€</button>
                </div>
                <div class="text-[10px] text-slate-400 italic">å¸¸ç”¨ï¼šå…ç¨…æ˜¯åœ¨å“ªè£¡ï¼Ÿ(å…ç¨ã¯ã©ã“ã§ã™ã‹ï¼Ÿ)</div>
            </div>

            <div class="mb-8">
                <h3 class="text-sm font-bold text-slate-700 mb-3">å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-note" oninput="saveMemo()" placeholder="æ¢åˆ—å¼ç­†è¨˜..." rows="5" class="w-full bg-white rounded-2xl p-4 card-shadow border-0 text-sm"></textarea>
            </div>

            <h3 class="text-sm font-bold text-slate-700 mb-4">é£¯åº—è³‡è¨Š</h3>
            <div id="hotel-info-list" class="space-y-6"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around p-3 pb-8 z-50">
        <button class="nav-btn nav-active" onclick="tab('plan', this)"><i class="fas fa-map-marked-alt text-xl mb-1"></i><p class="text-[10px]">PLAN</p></button>
        <button class="nav-btn text-slate-400" onclick="tab('wallet', this)"><i class="fas fa-wallet text-xl mb-1"></i><p class="text-[10px]">WALLET</p></button>
        <button class="nav-btn text-slate-400" onclick="tab('lists', this)"><i class="fas fa-tasks text-xl mb-1"></i><p class="text-[10px]">LISTS</p></button>
        <button class="nav-btn text-slate-400" onclick="tab('info', this)"><i class="fas fa-info-circle text-xl mb-1"></i><p class="text-[10px]">INFO</p></button>
    </nav>


    <script>
    // --- 1. Supabase åˆå§‹åŒ–è¨­å®š ---
    const SUPABASE_URL = 'https://avkkgiuqkipmzjeudscu.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jMgxCh5redMUsm4rMLifXQ_iL6JEpDE';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. åŸºç¤è³‡æ–™èˆ‡é ç®—è®Šæ•¸ ---
    const RATE = 0.21;
    const FIXED_COSTS = 19000 + 7500 + 2000; // æ©Ÿç¥¨+ä½å®¿+ç§Ÿè»Š (TWD)
    const TOTAL_BUDGET = 50000;              // ç¸½é ç®— (TWD)
    
    let activeDay = 1;
    let tempImg = "";
    
    const HOTELS = [
        { name: "JRä¹å·é£¯åº— Blossomé‚£éœ¸", img: "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=300", info: "D1", parking: "1,500 JPY/æ™š", time: "15:00 In / 11:00 Out" },
        { name: "æ²–ç¹©è’™ç‰¹åˆ© Spa åº¦å‡é…’åº—", img: "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=300", info: "D2", parking: "500 JPY/æ™š", time: "14:00 In / 11:00 Out" },
        { name: "æ˜Ÿé‡é›†åœ˜ BEB5 æ²–ç¹©ç€¨è‰¯å£", img: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=300", info: "D3", parking: "å…è²»åœè»Š", time: "15:00 In / 11:00 Out" }
    ];

    const defaultPlan = {
        1: [{ t: "15:45", s: "æŠµé”æ©Ÿå ´å–è»Š", l: "Naha Airport" }, { t: "18:30", s: "EIBUN/å°ã‚„ã˜", l: "EIBUN" }],
        2: [{ t: "11:00", s: "æ³¢ä¸Šå®®åƒæ‹œ", l: "Naminoue Shrine" }, { t: "12:30", s: "Cerrado Coffee", l: "Okinawa Cerrado Coffee" }, { t: "13:00", s: "A&W ç‰§æ¸¯åº—", l: "A&W Makiminato" }, { t: "14:00", s: "PARCO CITY", l: "PARCO CITY" }, { t: "17:00", s: "åŒ—è°·æ—¥è½", l: "Chatan Park" }],
        3: [{ t: "11:00", s: "ç¾éº—æµ·æ°´æ—é¤¨", l: "Churaumi" }, { t: "14:00", s: "Shinmei Coffee", l: "Shinmei Coffee" }, { t: "16:30", s: "å¤å®‡åˆ©è¦è¦é£¯", l: "Kouri Shrimp" }, { t: "18:30", s: "ç‰çƒä¹‹ç‰›", l: "Ryukyu no Ushi" }],
        4: [{ t: "10:30", s: "æ°¸æ—ºå¤¢æ¨‚åŸ", l: "Aeon Mall Rycom" }, { t: "12:00", s: "ç¾é£Ÿè¡—åˆé¤", l: "Rycom Food Court" }, { t: "14:45", s: "ç€¨é•·å³¶çœ‹é£›æ©Ÿ", l: "Umikaji Terrace" }, { t: "16:30", s: "é‚„è»ŠçµæŸ", l: "Naha Airport" }]
    };

    let plans = JSON.parse(localStorage.getItem('ok_plan_v7')) || defaultPlan;
    let bills = [];
    let lists = { pre: [], buy: [], eat: [] };
    let memoText = "";

    // --- 3. é›²ç«¯åŒæ­¥æ ¸å¿ƒé‚è¼¯ ---

    async function fetchAllData() {
        // æŠ“å¸³ç›®
        const { data: bData } = await _supabase.from('travel_bills').select('*').order('created_at', { ascending: false });
        if (bData) { bills = bData; renderBills(); }

        // æŠ“æ¸…å–®
        const { data: lData } = await _supabase.from('travel_lists').select('*');
        if (lData) {
            lists = { pre: [], buy: [], eat: [] };
            lData.forEach(item => lists[item.category].push(item));
            renderLists();
        }

        // æŠ“å‚™å¿˜éŒ„
        const { data: mData } = await _supabase.from('travel_memos').select('content').eq('id', 'memo-1').single();
        if (mData) { 
            document.getElementById('memo-note').value = mData.content;
        }
    }

    function initRealtime() {
        _supabase
            .channel('okinawa-sync')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'travel_bills' }, () => fetchAllData())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'travel_lists' }, () => fetchAllData())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'travel_memos' }, () => fetchAllData())
            .subscribe();
    }

    // --- 4. åŠŸèƒ½å‡½æ•¸ (UI & Logic) ---

    function tab(id, el) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${id}`).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('nav-active', 'text-slate-400'));
        el.classList.replace('text-slate-400', 'nav-active');
        window.scrollTo(0,0);
    }

    function switchDay(d) {
        activeDay = d;
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('day-btn-active'));
        document.getElementById(`d${d}-btn`).classList.add('day-btn-active');
        renderPlan();
    }
    
    function renderPlan() {
        document.getElementById('itinerary-content').innerHTML = plans[activeDay].map(i => `
            <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center">
                <div class="flex gap-4"><span class="text-sky-500 font-bold text-xs">${i.t}</span>
                <span class="text-sm font-bold text-slate-700">${i.s}</span></div>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.l)}" target="_blank" class="text-sky-300"><i class="fas fa-location-arrow"></i></a>
            </div>
        `).join('');
    }
    
    function editPlan() {
        const res = prompt("ç·¨è¼¯è¡Œç¨‹å…§å®¹ (JSONæ ¼å¼):", JSON.stringify(plans[activeDay]));
        if(res) { 
            plans[activeDay] = JSON.parse(res); 
            localStorage.setItem('ok_plan_v7', JSON.stringify(plans)); 
            renderPlan(); 
        }
    }

    // è¨ˆç®—æ©Ÿ
    let calcVal = "0";
    function pressCalc(v) { calcVal === "0" ? calcVal = v : calcVal += v; updateCalc(); }
    function clearCalc() { calcVal = "0"; document.getElementById('calc-exp').innerText = ""; updateCalc(); }
    function solveCalc() {
        try { document.getElementById('calc-exp').innerText = calcVal + " ="; calcVal = String(eval(calcVal)); } catch { calcVal = "Error"; }
        updateCalc();
    }
    function calcTax() { calcVal = String(Math.round(eval(calcVal) / 1.1)); updateCalc(); }
    function updateCalc() {
        document.getElementById('calc-main').innerText = calcVal;
        const res = isNaN(eval(calcVal)) ? 0 : eval(calcVal);
        document.getElementById('calc-twd').innerText = `â‰ˆ NT$ ${Math.round(res * RATE)}`;
    }

    // å¸³ç›®èˆ‡é ç®—
    async function saveBill() {
        const n = document.getElementById('bill-name').value;
        const a = document.getElementById('bill-amount').value;
        const p = document.getElementById('bill-payer').value;
        const m = document.getElementById('bill-method').value;
        if(!n || !a) return alert("è«‹è¼¸å…¥è³‡è¨Š");

        const { error } = await _supabase.from('travel_bills').insert([{ 
            name: n, amount: parseFloat(a), payer: p, method: m, image_url: tempImg 
        }]);

        if (error) alert("å­˜æª”å¤±æ•—: " + error.message);
        else {
            document.getElementById('bill-name').value = "";
            document.getElementById('bill-amount').value = "";
            document.getElementById('img-preview').classList.add('hidden');
            tempImg = "";
        }
    }

    function renderBills() {
        let sumJPY = 0;
        let sum00 = 0, sumYu = 0;
        const list = document.getElementById('bill-list');
        
        list.innerHTML = bills.map(b => {
            sumJPY += b.amount;
            b.payer === '00' ? sum00 += b.amount : sumYu += b.amount;
            return `
            <div class="bg-white p-3 rounded-2xl flex justify-between items-center border-l-4 ${b.payer === '00' ? 'border-sky-400' : 'border-rose-400'} mb-3">
                <div class="flex items-center gap-3">
                    ${b.image_url ? `<img src="${b.image_url}" class="w-10 h-10 rounded">` : `<div class="w-10 h-10 bg-slate-100 rounded"></div>`}
                    <div>
                        <div class="text-xs font-bold">${b.name}</div>
                        <div class="text-[9px] text-slate-400">${b.payer} ä»˜ | ${b.method}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs font-bold">Â¥${b.amount.toLocaleString()}</div>
                    <button onclick="delBill('${b.id}')" class="text-[10px] text-slate-300">åˆªé™¤</button>
                </div>
            </div>`;
        }).join('');
    
        // é ç®—æ›´æ–°
        const variableCostsTWD = Math.round(sumJPY * RATE);
        const totalSpentTWD = FIXED_COSTS + variableCostsTWD;
        const remainingTWD = TOTAL_BUDGET - totalSpentTWD;
        
        document.getElementById('remaining-twd').innerText = `NT$ ${remainingTWD.toLocaleString()}`;
        const spentPercent = Math.min((totalSpentTWD / TOTAL_BUDGET) * 100, 100);
        document.getElementById('budget-bar').style.width = `${spentPercent}%`;
        document.getElementById('budget-percent').innerText = `å·²æ”¯å‡º ${Math.round(spentPercent)}%`;
    
        if (remainingTWD < 0) {
            document.getElementById('remaining-twd').style.color = '#F43F5E';
        } else {
            document.getElementById('remaining-twd').style.color = '#334155';
        }

        // åˆ†å¸³ç¸½çµ
        const diff = Math.round(Math.abs(sum00 - sumYu) / 2);
        const summaryEl = document.getElementById('split-summary');
        if (summaryEl) {
            summaryEl.innerText = sum00 > sumYu ? `å°å®‡ æ‡‰çµ¦ 00 ç´„ Â¥${diff.toLocaleString()}` : `00 æ‡‰çµ¦ å°å®‡ ç´„ Â¥${diff.toLocaleString()}`;
        }
    }

    async function delBill(id) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        await _supabase.from('travel_bills').delete().eq('id', id);
    }

    async function addListItem(cat) {
        const val = document.getElementById(`input-${cat}`).value;
        if(!val) return;
        await _supabase.from('travel_lists').insert([{ category: cat, item_text: val, is_done: false }]);
        document.getElementById(`input-${cat}`).value = "";
    }

    async function toggleItem(id, currentStatus) {
        await _supabase.from('travel_lists').update({ is_done: !currentStatus }).eq('id', id);
    }

    async function delItem(id) {
        await _supabase.from('travel_lists').delete().eq('id', id);
    }

    function renderLists() {
        ['pre', 'buy', 'eat'].forEach(cat => {
            const container = document.querySelector(`#cat-${cat} .list-container`);
            container.innerHTML = lists[cat].map((it) => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3" onclick="toggleItem('${it.id}', ${it.is_done})">
                        <i class="${it.is_done ? 'fas fa-check-circle text-sky-500' : 'far fa-circle text-slate-200'}"></i>
                        <span class="text-sm ${it.is_done ? 'line-through-text' : ''}">${it.item_text}</span>
                    </div>
                    <i class="fas fa-times text-slate-200" onclick="delItem('${it.id}')"></i>
                </div>
            `).join('');
        });
    }

    let memoTimeout;
    function saveMemo() {
        const content = document.getElementById('memo-note').value;
        clearTimeout(memoTimeout);
        memoTimeout = setTimeout(async () => {
            const { error } = await _supabase.from('travel_memos').upsert([{ id: 'memo-1', content: content }]);
        }, 1000);
    }

    function goTranslate(lang) { window.open(`https://translate.google.com/?sl=zh-CN&tl=${lang}&text=${encodeURIComponent(document.getElementById('trans-input').value)}&op=translate`, '_blank'); }
    function ttsJapanese() { const msg = new SpeechSynthesisUtterance(document.getElementById('trans-input').value); msg.lang = 'ja-JP'; window.speechSynthesis.speak(msg); }
    
    function renderHotels() {
        document.getElementById('hotel-info-list').innerHTML = HOTELS.map(h => `
            <div class="bg-white rounded-3xl overflow-hidden shadow-sm">
                <img src="${h.img}" class="w-full h-32 object-cover">
                <div class="p-4"><div class="flex justify-between font-bold mb-2"><span>${h.name}</span><span class="text-sky-500">${h.info}</span></div>
                <div class="text-[11px] text-slate-400">ğŸ…¿ï¸ ${h.parking} | ğŸ•’ ${h.time}</div></div>
            </div>
        `).join('');
    }

    function compressImg(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 150; canvas.height = 150;
                ctx.drawImage(img, 0, 0, 150, 150);
                tempImg = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('img-preview').innerHTML = `<img src="${tempImg}" class="w-full h-full object-cover">`;
                document.getElementById('img-preview').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    window.onload = () => {
        switchDay(1); 
        renderHotels();
        fetchAllData();   
        initRealtime();   
    };
</script>
</body>
</html>
