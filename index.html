<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morandi Travel Planner è«è˜­è¿ªæ—…éŠåŠ©æ‰‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ9u7E1D8Q3Gpnh0ySgG+i/O7J+tQ6v/Wd5nNlE/C8f7m42s5r5F4/L0D4qI/O9I0Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* è«è˜­è¿ª/å¥¶èŒ¶é¢¨æ ¼é…è‰² */
        :root {
            --color-primary: #D7C49E; /* æ·ºå’–/å¥¶èŒ¶ */
            --color-secondary: #F7F5E6; /* ç±³ç™½/èƒŒæ™¯ */
            --color-accent: #AEC6CF; /* è«è˜­è¿ªè— */
            --color-dark: #6B5B54; /* æ·±å’–/æ–‡å­— */
            --color-light: #FFFFFF; /* ç´”ç™½ */
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-secondary);
            color: var(--color-dark);
        }
        /* èª¿æ•´å­—é«”é¢¨æ ¼ï¼Œè®“æ¨™é¡Œå¸¶æœ‰å„ªé›…æ„Ÿ */
        h1, h2, h3 {
            font-family: 'Lora', serif;
        }
        /* å¡ç‰‡é¢¨æ ¼ - åœ“è§’ã€æ·ºé™°å½± */
        .card {
            background-color: var(--color-light);
            border-radius: 1.25rem; /* è¼ƒå¤§åœ“è§’ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* æŸ”å’Œé™°å½± */
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }

        /* æŒ‰éˆ•é¢¨æ ¼ */
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-light);
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--color-dark);
        }

        /* å°èˆªåˆ—é¢¨æ ¼ */
        .nav-icon {
            color: var(--color-dark);
        }
        .nav-icon.active {
            color: var(--color-accent);
            transform: scale(1.1);
        }

        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.125rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-primary);
            z-index: 0;
        }

        /* æ™‚é–“è»¸åœ“é» */
        .timeline-dot {
            position: absolute;
            left: -0.375rem;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            background-color: var(--color-accent);
            border-radius: 50%;
            border: 2px solid var(--color-light);
            z-index: 10;
        }

        /* å…§å®¹å€å¡Šæ²å‹•æ™‚ä¸è®“åº•éƒ¨å°èˆªé®è“‹ */
        main {
            padding-bottom: 5rem; /* é ç•™åº•éƒ¨å°èˆªé«˜åº¦ */
        }

        /* éš±è—é è¨­çš„æª”æ¡ˆè¼¸å…¥æ¡† */
        .hidden-file-input {
            display: none;
        }

    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 p-4 shadow-md z-20" style="background-color: var(--color-secondary);">
        <h1 class="text-2xl font-bold text-center" style="color: var(--color-primary);">My Travel Buddy</h1>
    </header>

    <main class="p-4 overflow-y-auto">

        <section id="plan" class="tab-content active">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">âœˆï¸ è¡Œç¨‹ç¸½è¦½ PLAN</h2>

            <div class="space-y-4 mb-6">
                <div class="card p-4">
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-ticket-alt"></i> äº¤é€š/ä½å®¿è³‡è¨Š</h3>
                    <div id="info-display">
                        <p class="text-sm">å°šæœªè¨­å®šåŸºæœ¬è³‡è¨Š</p>
                    </div>
                    <button class="btn-primary w-full mt-2" onclick="openModal('info-modal')">
                        ç·¨è¼¯åŸºæœ¬è³‡è¨Š
                    </button>
                </div>
            </div>

            <div id="daily-schedule" class="space-y-6">
                </div>
        </section>

        <section id="guide" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ—ºï¸ æ·±åº¦å°è¦½ GUIDE</h2>

            <div class="card p-5 space-y-6">
                <p class="text-center italic text-sm" style="color: var(--color-dark);">â€”â€” æ—…éŠæ‰‹å†Šç²¾é¸å°è¦½ â€”â€”</p>

                <div class="border-b pb-4" style="border-color: var(--color-primary);">
                    <h3 class="text-2xl font-semibold mb-2" style="color: var(--color-primary);">æ±äº¬è¿ªå£«å°¼æ¨‚åœ’</h3>
                    <p class="text-sm mb-3 leading-relaxed">
                        **æ­·å²èƒŒæ™¯èˆ‡å†·çŸ¥è­˜ï¼š** æ±äº¬è¿ªå£«å°¼æ˜¯ç¬¬ä¸€å€‹åœ¨ç¾åœ‹æœ¬åœŸä»¥å¤–å»ºé€ çš„è¿ªå£«å°¼æ¨‚åœ’ï¼Œæ–¼ 1983 å¹´é–‹æ”¾ã€‚åœ’å€å…§çš„ã€Œç°å§‘å¨˜åŸå ¡ã€æ¯”ä½›ç¾…é‡Œé”å·çš„é­”è¡“ç‹åœ‹åŸå ¡æ›´é«˜å¤§ï¼Œæ˜¯æ‹ç…§çš„çµ•ä½³åœ°é»ã€‚æ“šèªªï¼Œåœ’å€å…§è¨±å¤šç´°ç¯€è¨­è¨ˆï¼Œéƒ½è—è‘—ç±³å¥‡çš„éš±è—åœ–æ¡ˆç­‰ä½ ç™¼æ˜ï¼
                    </p>
                    <a href="https://www.google.com/maps/search/?api=1&query=æ±äº¬è¿ªå£«å°¼æ¨‚åœ’" target="_blank" class="text-sm block underline" style="color: var(--color-accent);"><i class="fas fa-map-marker-alt"></i> Google Maps å°èˆª</a>
                </div>

                <div class="border-b pb-4" style="border-color: var(--color-primary);">
                    <h3 class="text-2xl font-semibold mb-2" style="color: var(--color-primary);">æ—¥æœ¬ç’°çƒå½±åŸ (USJ)</h3>
                    <p class="text-sm mb-3 leading-relaxed">
                        **ä¸å¯éŒ¯éï¼š** è¶…ç´šä»»å¤©å ‚ä¸–ç•Œ (Super Nintendo World) æ˜¯ç›®å‰ USJ æœ€ç†±é–€çš„å€åŸŸï¼Œå»ºè­°ä¸€å…¥åœ’å°±å»æŠ½æ•´ç†åˆ¸ï¼ä¹˜åã€Œç‘ªåˆ©æ­è³½è»Šã€æ™‚ï¼Œè¨˜å¾—å¤šç·´ç¿’ä¸Ÿé¾œæ®¼ï¼Œæ‰èƒ½ç²å¾—é«˜åˆ†ã€‚
                    </p>
                    <div class="h-64 mt-4 overflow-hidden rounded-lg shadow-inner">
                        <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
                            src="https://www.openstreetmap.org/export/embed.html?bbox=135.4385%2C34.6644%2C135.4485%2C34.6744&amp;layer=mapnik&amp;marker=34.6694,135.4435"
                            style="border: 1px solid black;">
                        </iframe>
                    </div>
                </div>
            </div>
        </section>

        <section id="wallet" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ WALLET</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-calculator"></i> å³æ™‚åŒ¯ç‡æ›ç®—</h3>
                <div class="flex space-x-2 mb-2">
                    <label for="exchange-rate" class="block text-sm font-medium pt-2">1 JPY â‰ˆ</label>
                    <input type="number" id="exchange-rate" value="0.215" step="0.001" class="w-20 p-2 border rounded-lg text-center" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <span class="block text-sm font-medium pt-2">TWD (è‡ªè¨‚åŒ¯ç‡)</span>
                </div>

                <div class="flex mb-2 space-x-2">
                    <input type="text" id="calc-input" placeholder="è¼¸å…¥é‡‘é¡æˆ–ç®—å¼ (e.g., 500+200*3)" class="flex-grow p-3 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <button class="btn-primary" onclick="calculateExchange()">=</button>
                </div>
                <div class="text-right text-lg font-bold">
                    <span id="calc-result-foreign" class="text-red-600">0</span>
                    <span class="text-sm"> å¤–å¹£ â‰ˆ </span>
                    <span id="calc-result-twd" style="color: var(--color-dark);">0.00 TWD</span>
                </div>
            </div>

            <div class="card p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-receipt"></i> æ–°å¢æ¶ˆè²»ç´€éŒ„</h3>
                <input type="text" id="expense-item" placeholder="å“é …åç¨± (e.g. åˆé¤)" class="w-full p-3 mb-2 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                <input type="number" id="expense-amount" placeholder="é‡‘é¡ (å¤–å¹£)" class="w-full p-3 mb-2 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">

                <input type="file" id="expense-photo-input" accept="image/*" class="hidden-file-input" onchange="handleImageUpload(event)">
                <button class="btn-primary w-full mb-2" onclick="document.getElementById('expense-photo-input').click()">
                    <i class="fas fa-camera"></i> ä¸Šå‚³æ”¶æ“š/ç…§ç‰‡ (å°‡è‡ªå‹•å£“ç¸®)
                </button>
                <div id="photo-preview-container" class="mb-2 text-center hidden">
                    <p class="text-sm italic">å·²é¸å–ç…§ç‰‡ï¼Œå°‡è‡ªå‹•å£“ç¸®</p>
                </div>

                <button class="btn-primary w-full" onclick="addExpense()">
                    å„²å­˜è¨˜å¸³
                </button>
            </div>

            <div class="card p-4">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-list-alt"></i> è¨˜å¸³æ­·å²</h3>
                <div id="expense-history" class="space-y-4">
                    </div>
                <div class="mt-4 pt-4 border-t" style="border-color: var(--color-primary);">
                    <h4 class="text-lg font-bold">ç¸½æ”¯å‡ºï¼š
                        <span id="total-foreign" class="text-red-600">0</span> å¤–å¹£ â‰ˆ
                        <span id="total-twd" style="color: var(--color-dark);">0.00 TWD</span>
                    </h4>
                </div>
            </div>
        </section>

        <section id="lists" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ“‹ æ¸…å–®å‚™å¿˜ LISTS</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-suitcase-rolling"></i> è¡Œå‰æº–å‚™æ¸…å–®</h3>
                <div class="flex mb-2 space-x-2">
                    <input type="text" id="new-checklist-item" placeholder="æ–°å¢æº–å‚™é …ç›®" class="flex-grow p-2 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <button class="btn-primary" onclick="addChecklistItem()">æ–°å¢</button>
                </div>
                <ul id="checklist-items" class="space-y-2">
                    </ul>
            </div>

            <div class="card p-4">
                <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-clipboard"></i> å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-input" rows="5" placeholder="è‡ªç”±è¼¸å…¥æ–‡å­—ï¼Œç¶²å€æœƒè‡ªå‹•è½‰æ›æˆé€£çµæŒ‰éˆ•..."
                    class="w-full p-3 border rounded-lg mb-3" style="border-color: var(--color-primary); background-color: var(--color-secondary);"
                    oninput="saveMemo()"></textarea>

                <div id="memo-display" class="p-3 border rounded-lg" style="border-color: var(--color-primary); background-color: var(--color-secondary);">
                    <p class="text-sm italic">å‚™å¿˜éŒ„å…§å®¹ (é€£çµå°‡æœƒè‡ªå‹•ç”Ÿæˆ)</p>
                    </div>
            </div>
        </section>

        <section id="info" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-4 text-center" style="color: var(--color-dark);">ğŸ’¡ å¯¦ç”¨è³‡è¨Š INFO</h2>

            <div class="card p-4 space-y-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-cloud-sun-rain"></i> å¤©æ°£é å ±</h3>
                    <p class="text-sm mb-2">è«‹é»æ“ŠæŸ¥çœ‹ç•¶åœ°æœ€æ–°å¤©æ°£è³‡è¨Šï¼š</p>
                    <a href="https://www.cwb.gov.tw/V8/C/W/index.html" target="_blank" class="btn-primary inline-block text-center text-sm" style="background-color: var(--color-accent);">
                        <i class="fas fa-umbrella"></i> å°ç£å°åŒ—ä¸­å¤®æ°£è±¡ç½²
                    </a>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-phone-alt"></i> ç·Šæ€¥è¯çµ¡è³‡è¨Š</h3>
                    <ul class="text-sm space-y-1">
                        <li>**è­¦å¯Ÿ:** 110 (å°ç£), 110 (æ—¥æœ¬)</li>
                        <li>**æ•‘è­·è»Š:** 119 (å°ç£), 119 (æ—¥æœ¬)</li>
                        <li>**å¤–äº¤éƒ¨æ—…å¤–åœ‹äººç·Šæ€¥æœå‹™å°ˆç·š:** <a href="tel:+886800085095" class="underline" style="color: var(--color-accent);">(+886) 800-085-095</a></li>
                        <li>**å°ç£é§å¤–è¾¦äº‹è™•:** <a href="https://www.boca.gov.tw/mp-1.html" target="_blank" class="underline" style="color: var(--color-accent);">é»æ­¤æŸ¥è©¢</a></li>
                    </ul>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2" style="color: var(--color-accent);"><i class="fas fa-exclamation-triangle"></i> æ—…éŠæ³¨æ„äº‹é …</h3>
                    <ul class="text-sm space-y-1 list-disc list-inside">
                        <li>å‡ºå…¥å¢ƒå‰è«‹ç¢ºèª**é•ç¦å“æ¸…å–®** (å¦‚è‚‰è£½å“ã€ç‰¹å®šè—¥å“)ã€‚</li>
                        <li>è«‹ä¿æŒç’°å¢ƒæ•´æ½”ï¼Œå…¬å…±å ´æ‰€ä¸å¤§è²å–§å˜©ã€‚</li>
                        <li>åœ¨åœ‹å¤–é‡åˆ°å›°é›£ï¼Œè«‹å„ªå…ˆè¯ç¹«ç•¶åœ°è­¦å¯Ÿæˆ–å°ç£è¾¦äº‹è™•ã€‚</li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-20 shadow-lg flex justify-around items-center z-30" style="background-color: var(--color-light); border-top: 1px solid var(--color-primary);">
        <button class="nav-btn flex flex-col items-center p-2" data-tab="plan" onclick="switchTab('plan')">
            <i class="fas fa-plane nav-icon text-2xl active"></i>
            <span class="text-xs mt-1">PLAN</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="guide" onclick="switchTab('guide')">
            <i class="fas fa-book-open nav-icon text-2xl"></i>
            <span class="text-xs mt-1">GUIDE</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="wallet" onclick="switchTab('wallet')">
            <i class="fas fa-wallet nav-icon text-2xl"></i>
            <span class="text-xs mt-1">WALLET</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="lists" onclick="switchTab('lists')">
            <i class="fas fa-list-check nav-icon text-2xl"></i>
            <span class="text-xs mt-1">LISTS</span>
        </button>
        <button class="nav-btn flex flex-col items-center p-2" data-tab="info" onclick="switchTab('info')">
            <i class="fas fa-info-circle nav-icon text-2xl"></i>
            <span class="text-xs mt-1">INFO</span>
        </button>
    </nav>

    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <div class="card w-full max-w-md p-6" style="background-color: var(--color-secondary);">
            <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">ç·¨è¼¯æ—…éŠåŸºæœ¬è³‡è¨Š</h3>

            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">è»Šç¥¨/èˆªç­è³‡è¨Š</label>
                <textarea id="input-transport" rows="3" class="w-full p-2 border rounded-lg" placeholder="è«‹å¡«å…¥æ­ä¹˜æ—¥æœŸã€è»Šæ¬¡ã€èˆªç­è™Ÿç¢¼..." style="border-color: var(--color-primary);"></textarea>
            </div>

            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">ä½å®¿è³‡è¨Š</label>
                <textarea id="input-lodging" rows="3" class="w-full p-2 border rounded-lg" placeholder="è«‹å¡«å…¥ä½å®¿æ—¥æœŸã€é£¯åº—åç¨±èˆ‡åœ°å€..." style="border-color: var(--color-primary);"></textarea>
            </div>

            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">D1 è¡Œç¨‹</label>
                <textarea id="input-day1" rows="3" class="w-full p-2 border rounded-lg" placeholder="ç¬¬ä¸€å¤©è¡Œç¨‹å…§å®¹..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">D2 è¡Œç¨‹</label>
                <textarea id="input-day2" rows="3" class="w-full p-2 border rounded-lg" placeholder="ç¬¬äºŒå¤©è¡Œç¨‹å…§å®¹..." style="border-color: var(--color-primary);"></textarea>
            </div>
            <div class="mb-4">
                <label class="block font-medium mb-1" style="color: var(--color-dark);">D3 è¡Œç¨‹</label>
                <textarea id="input-day3" rows="3" class="w-full p-2 border rounded-lg" placeholder="ç¬¬ä¸‰å¤©è¡Œç¨‹å…§å®¹..." style="border-color: var(--color-primary);"></textarea>
            </div>


            <div class="flex justify-end space-x-3">
                <button class="btn-primary" onclick="saveTripInfo()">å„²å­˜ä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>


    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const DB_PREFIX = 'TRAVEL_APP_';

        // è¼‰å…¥æ‰€æœ‰ LocalStorage è³‡æ–™
        document.addEventListener('DOMContentLoaded', () => {
            loadTripInfo();
            loadChecklist();
            loadMemo();
            loadExpenses();
            // é è¨­åˆ‡æ›åˆ° PLAN é é¢
            switchTab('plan');
        });

        // --- å°èˆªèˆ‡åˆ†é åˆ‡æ›åŠŸèƒ½ ---
        function switchTab(tabId) {
            // éš±è—æ‰€æœ‰å…§å®¹
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
            });

            // é¡¯ç¤ºç›®æ¨™å…§å®¹
            document.getElementById(tabId).classList.remove('hidden');

            // æ›´æ–°å°èˆªåˆ—åœ–æ¨™æ¨£å¼
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-tab="${tabId}"] .nav-icon`).classList.add('active');

            // é‡å° PLAN é é¢ï¼Œç¢ºä¿è¼‰å…¥å¾Œé‡æ–°æ¸²æŸ“è¡Œç¨‹
            if (tabId === 'plan') {
                renderDailySchedule();
            }
        }

        function openModal(modalId, day = null) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex'; // è®“å®ƒå±…ä¸­é¡¯ç¤º
            if (day) {
                 // é€™è£¡æ˜¯ç‚ºæœªä¾†æ“´å……å–®ç¨ç·¨è¼¯æŸå¤©è¡Œç¨‹çš„é ç•™
            } else if (modalId === 'info-modal') {
                // è¼‰å…¥åŸºæœ¬è³‡è¨Šåˆ° Modal
                const data = JSON.parse(localStorage.getItem(DB_PREFIX + 'trip_info')) || {};
                document.getElementById('input-transport').value = data.transport || '';
                document.getElementById('input-lodging').value = data.lodging || '';
                document.getElementById('input-day1').value = data.day1 || '';
                document.getElementById('input-day2').value = data.day2 || '';
                document.getElementById('input-day3').value = data.day3 || '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- 1. PLAN (è¡Œç¨‹è¡¨) æ¨¡çµ„ ---

        function saveTripInfo() {
            const info = {
                transport: document.getElementById('input-transport').value.trim(),
                lodging: document.getElementById('input-lodging').value.trim(),
                day1: document.getElementById('input-day1').value.trim(),
                day2: document.getElementById('input-day2').value.trim(),
                day3: document.getElementById('input-day3').value.trim(),
            };
            localStorage.setItem(DB_PREFIX + 'trip_info', JSON.stringify(info));
            loadTripInfo();
            renderDailySchedule();
            closeModal('info-modal');
        }

        function loadTripInfo() {
            const data = JSON.parse(localStorage.getItem(DB_PREFIX + 'trip_info')) || {};
            const infoDisplay = document.getElementById('info-display');

            const transportText = data.transport ? `<p class="text-sm">**äº¤é€š:** ${data.transport.replace(/\n/g, '<br>')}</p>` : '';
            const lodgingText = data.lodging ? `<p class="text-sm">**ä½å®¿:** ${data.lodging.replace(/\n/g, '<br>')}</p>` : '';

            if (transportText || lodgingText) {
                infoDisplay.innerHTML = transportText + lodgingText;
            } else {
                infoDisplay.innerHTML = '<p class="text-sm italic">å°šæœªè¨­å®šåŸºæœ¬è³‡è¨Šï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ã€‚</p>';
            }
        }

        function renderDailySchedule() {
            const data = JSON.parse(localStorage.getItem(DB_PREFIX + 'trip_info')) || {};
            const scheduleContainer = document.getElementById('daily-schedule');
            scheduleContainer.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

            const days = [
                { id: 'day1', title: 'Day 1 è¡Œç¨‹', content: data.day1 || 'å°šæœªè¨­å®š D1 è¡Œç¨‹' },
                { id: 'day2', title: 'Day 2 è¡Œç¨‹', content: data.day2 || 'å°šæœªè¨­å®š D2 è¡Œç¨‹' },
                { id: 'day3', title: 'Day 3 è¡Œç¨‹', content: data.day3 || 'å°šæœªè¨­å®š D3 è¡Œç¨‹' },
            ];

            days.forEach(day => {
                // å°‡è¡Œç¨‹å…§å®¹æŒ‰æ›è¡Œç¬¦åˆ†å‰²æˆå¤šå€‹åœ°é»
                const items = day.content.split('\n').filter(line => line.trim() !== '');

                // å»ºç«‹æ™‚é–“è»¸çµæ§‹
                const scheduleCard = document.createElement('div');
                scheduleCard.className = 'card p-5';
                scheduleCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-4" style="color: var(--color-accent);">${day.title}</h3>
                    <div class="relative space-y-6">
                        ${items.map(item => {
                            // å˜—è©¦å°‡åœ°é»è¦–ç‚º Google Maps æŸ¥è©¢çš„é—œéµå­—
                            const query = encodeURIComponent(item.split(' ')[0]); // å–ç¬¬ä¸€å€‹è©ç•¶ä½œåœ°é»
                            return `
                                <div class="timeline-item relative pl-8">
                                    <div class="timeline-dot"></div>
                                    <p class="font-medium">${item}</p>
                                    <div class="flex space-x-2 mt-1 text-xs">
                                        <a href="https://www.google.com/maps/search/?api=1&query=${query}" target="_blank"
                                            class="flex items-center text-white px-2 py-1 rounded-full" style="background-color: var(--color-accent);">
                                            <i class="fas fa-map-marker-alt mr-1"></i> åœ°åœ–
                                        </a>
                                        <a href="https://www.google.com/search?q=${query}+é£Ÿè¨˜" target="_blank"
                                            class="flex items-center text-white px-2 py-1 rounded-full" style="background-color: var(--color-primary);">
                                            <i class="fas fa-utensils mr-1"></i> é£Ÿè¨˜
                                        </a>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                scheduleContainer.appendChild(scheduleCard);
            });

            // å¦‚æœæ²’æœ‰ä»»ä½•è¡Œç¨‹ï¼Œå‰‡é¡¯ç¤ºæç¤º
            if (days.every(d => !d.content)) {
                scheduleContainer.innerHTML = '<p class="text-center p-4 italic" style="color: var(--color-dark);">å°šç„¡è¡Œç¨‹è³‡æ–™ï¼Œè«‹é»æ“Šã€Œç·¨è¼¯åŸºæœ¬è³‡è¨Šã€æ–°å¢ã€‚</p>';
            }
        }


        // --- 3. WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) æ¨¡çµ„ ---

        let expensePhotoBase64 = null; // æš«å­˜ä¸Šå‚³çš„ Base64 åœ–ç‰‡

        function calculateExchange() {
            const inputEl = document.getElementById('calc-input');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0;
            const foreignResultEl = document.getElementById('calc-result-foreign');
            const twdResultEl = document.getElementById('calc-result-twd');

            let foreignAmount = 0;
            try {
                // ä½¿ç”¨ eval åŸ·è¡Œç®—å¼ï¼Œä½†éœ€è¦æ³¨æ„å®‰å…¨æ€§ (æ­¤è™•ç‚ºå–®æ©Ÿç¶²é ï¼Œé¢¨éšªè¼ƒä½)
                foreignAmount = eval(inputEl.value.trim().replace(/[^-()\d/*+. ]/g, ''));
                if (isNaN(foreignAmount)) foreignAmount = 0;
                // å°‡çµæœå›å¡«åˆ°è¼¸å…¥æ¡†
                inputEl.value = foreignAmount;
            } catch (e) {
                foreignAmount = 0;
                inputEl.value = 'éŒ¯èª¤: ç„¡æ•ˆç®—å¼';
            }

            const twdAmount = foreignAmount * rate;

            foreignResultEl.textContent = foreignAmount.toFixed(0);
            twdResultEl.textContent = twdAmount.toFixed(2);
        }

        // åœ–ç‰‡å£“ç¸®ä¸¦è½‰ Base64
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const MAX_WIDTH = 200; // å£“ç¸®å¾Œçš„ç¸®åœ–æœ€å¤§å¯¬åº¦
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // å£“ç¸®ç‚º Base64 (JPEG, å“è³ª 70%)
                    expensePhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0;

            if (!item || isNaN(amount) || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …å’Œé‡‘é¡ã€‚');
                return;
            }

            const expenses = JSON.parse(localStorage.getItem(DB_PREFIX + 'expenses')) || [];
            const newExpense = {
                id: Date.now(),
                item: item,
                amount: amount,
                twd: amount * rate,
                photo: expensePhotoBase64, // å­˜å…¥å£“ç¸®å¾Œçš„ Base64 åœ–ç‰‡
                timestamp: new Date().toLocaleDateString('zh-TW')
            };

            expenses.unshift(newExpense); // æ–°çš„é …ç›®æ”¾åœ¨æœ€å‰é¢
            localStorage.setItem(DB_PREFIX + 'expenses', JSON.stringify(expenses));

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-photo-input').value = ''; // æ¸…ç©º file input
            expensePhotoBase64 = null;
            document.getElementById('photo-preview-container').classList.add('hidden');

            loadExpenses();
        }

        function deleteExpense(id) {
            let expenses = JSON.parse(localStorage.getItem(DB_PREFIX + 'expenses')) || [];
            expenses = expenses.filter(exp => exp.id !== id);
            localStorage.setItem(DB_PREFIX + 'expenses', JSON.stringify(expenses));
            loadExpenses();
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem(DB_PREFIX + 'expenses')) || [];
            const container = document.getElementById('expense-history');
            const totalForeignEl = document.getElementById('total-foreign');
            const totalTwdEl = document.getElementById('total-twd');
            container.innerHTML = '';
            
            let totalForeign = 0;
            let totalTwd = 0;

            expenses.forEach(exp => {
                totalForeign += exp.amount;
                totalTwd += exp.twd;

                const photoHtml = exp.photo
                    ? `<img src="${exp.photo}" alt="æ”¶æ“š" class="w-12 h-12 object-cover rounded-md mr-3 shadow-md">`
                    : `<div class="w-12 h-12 flex items-center justify-center rounded-md mr-3" style="background-color: var(--color-secondary);"><i class="fas fa-image text-lg" style="color: var(--color-primary);"></i></div>`;

                const expenseItem = document.createElement('div');
                expenseItem.className = 'flex items-center p-3 rounded-lg border-b'
                expenseItem.style.borderColor = 'var(--color-secondary)';
                expenseItem.innerHTML = `
                    ${photoHtml}
                    <div class="flex-grow">
                        <p class="font-medium text-sm">${exp.item}</p>
                        <p class="text-xs text-gray-500">${exp.timestamp}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="font-bold text-sm text-red-600">${exp.amount.toFixed(0)} å¤–å¹£</p>
                        <p class="text-xs" style="color: var(--color-dark);">â‰ˆ ${exp.twd.toFixed(2)} TWD</p>
                    </div>
                    <button class="ml-3 text-red-500 hover:text-red-700" onclick="deleteExpense(${exp.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                container.appendChild(expenseItem);
            });

            totalForeignEl.textContent = totalForeign.toFixed(0);
            totalTwdEl.textContent = totalTwd.toFixed(2);

            if (expenses.length === 0) {
                 container.innerHTML = '<p class="text-center italic text-sm">å°šç„¡æ¶ˆè²»ç´€éŒ„ã€‚</p>';
            }
        }


        // --- 4. LISTS (æ¸…å–®) æ¨¡çµ„ ---

        // è¡Œå‰æº–å‚™ CheckList
        function addChecklistItem() {
            const input = document.getElementById('new-checklist-item');
            const itemText = input.value.trim();
            if (!itemText) return;

            let checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            checklist.push({ id: Date.now(), text: itemText, completed: false });
            localStorage.setItem(DB_PREFIX + 'checklist', JSON.stringify(checklist));
            input.value = '';
            loadChecklist();
        }

        function toggleChecklistItem(id) {
            let checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            const index = checklist.findIndex(item => item.id === id);
            if (index > -1) {
                checklist[index].completed = !checklist[index].completed;
                localStorage.setItem(DB_PREFIX + 'checklist', JSON.stringify(checklist));
                loadChecklist();
            }
        }

        function deleteChecklistItem(id) {
            let checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            checklist = checklist.filter(item => item.id !== id);
            localStorage.setItem(DB_PREFIX + 'checklist', JSON.stringify(checklist));
            loadChecklist();
        }

        function loadChecklist() {
            const checklist = JSON.parse(localStorage.getItem(DB_PREFIX + 'checklist')) || [];
            const container = document.getElementById('checklist-items');
            container.innerHTML = '';

            checklist.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-lg';
                li.style.backgroundColor = item.completed ? '#E0F2F1' : 'var(--color-light)';

                const textClass = item.completed ? 'line-through text-gray-500' : 'font-medium';
                li.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" ${item.completed ? 'checked' : ''}
                               onclick="toggleChecklistItem(${item.id})"
                               class="w-4 h-4 mr-3" style="accent-color: var(--color-accent);">
                        <span class="${textClass}">${item.text}</span>
                    </div>
                    <button class="text-red-400 hover:text-red-600 ml-3" onclick="deleteChecklistItem(${item.id})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(li);
            });
            if (checklist.length === 0) {
                 container.innerHTML = '<p class="text-center italic text-sm">å°šç„¡æº–å‚™é …ç›®ã€‚</p>';
            }
        }

        // å€‹äººå‚™å¿˜éŒ„
        function saveMemo() {
            const memoText = document.getElementById('memo-input').value;
            localStorage.setItem(DB_PREFIX + 'memo', memoText);
            renderMemo(memoText);
        }

        function loadMemo() {
            const memoText = localStorage.getItem(DB_PREFIX + 'memo') || '';
            document.getElementById('memo-input').value = memoText;
            renderMemo(memoText);
        }

        function renderMemo(text) {
            const display = document.getElementById('memo-display');
            // åŒ¹é…ç¶²å€çš„æ­£è¦è¡¨é”å¼ (ç°¡åŒ–ç‰ˆ)
            const urlRegex = /(https?:\/\/[^\s]+)/g;

            // å°‡ç´”æ–‡å­—ä¸­çš„ç¶²å€è½‰æ›ç‚ºå¯é»æ“Šçš„æŒ‰éˆ•
            const htmlContent = text.replace(/\n/g, '<br>').replace(urlRegex, (url) => {
                const buttonText = url.length > 30 ? url.substring(0, 27) + '...' : url;
                return `
                    <a href="${url}" target="_blank" class="inline-block my-1 mx-0.5 btn-primary text-sm p-1" style="background-color: var(--color-accent);">
                        <i class="fas fa-link"></i> ${buttonText}
                    </a>
                `;
            });
            display.innerHTML = htmlContent || '<p class="text-sm italic">å‚™å¿˜éŒ„å…§å®¹ (é€£çµå°‡æœƒè‡ªå‹•ç”Ÿæˆ)</p>';
        }

        // --- å•Ÿå‹•æ™‚è¼‰å…¥è³‡æ–™ ---
        // æ”¾åœ¨ DOMContentLoaded ä¹‹å¾ŒåŸ·è¡Œ
    </script>

</body>
</html>
